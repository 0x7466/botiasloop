#!/usr/bin/env ruby
# frozen_string_literal: true

require_relative "../lib/botiasloop"

def print_help
  puts "botiasloop - Minimal agentic AI with ReAct loop"
  puts
  puts "Usage: botiasloop [OPTIONS] [COMMAND]"
  puts
  puts "Options:"
  puts "  -h, --help       Show this help message"
  puts "  -v, --version    Show version information"
  puts
  puts "Commands:"
  puts "  cli              Start interactive REPL mode"
  puts "  gateway          Start gateway (Telegram bot and other channels)"
  puts "  help             Show this help message"
end

if ARGV[0] == "-h" || ARGV[0] == "--help"
  print_help
elsif ARGV[0] == "-v" || ARGV[0] == "--version"
  puts "botiasloop #{Botiasloop::VERSION}"
elsif ARGV[0] == "gateway"
  # Gateway mode - auto-start all registered channels using ChannelsManager
  config = Botiasloop::Config.new
  manager = Botiasloop::ChannelsManager.new(config)

  # Check if any channels are configured (excluding CLI)
  available_channels = Botiasloop::Channels.registry.channels.reject { |name, _| name == :cli }

  if available_channels.empty?
    puts "No gateway channels configured."
    puts "Configure at least one channel (e.g., Telegram) in ~/.config/botiasloop/config.yml"
    exit 1
  end

  # Start all channels and wait
  manager.start_channels.wait
elsif ARGV[0] == "cli"
  # CLI interactive mode
  config = Botiasloop::Config.new
  cli_channel = Botiasloop::Channels::CLI.new(config)
  cli_channel.start
elsif ARGV.empty? || ARGV[0] == "help"
  # Default to help when no args or explicit help command
  print_help
else
  # Unknown command
  puts "Unknown command: #{ARGV[0]}"
  puts
  print_help
  exit 1
end
